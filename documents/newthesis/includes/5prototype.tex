

\chapter{Prototype System}
We have so far introduced our conceptual model for reactive \textrm{\glspl{infosystem}} and their Services and some example use cases to point out what would be possible with our model.
In this chapter we present our proof of concept prototype system, which has a focus on the Web as its \textrm{\glspl{infospace}}.
We will then introduce our \textrm{\acrshort{eca}} rule language, which gives all the necessary power over our prototype system and which can be directly translated into the internal rules representation.



\section{Architecture}
The prototype system is the adoption of our conceptual model for reactive \textrm{\glspl{infosystem}} and their services to the Web.
The Web consists of many \textrm{\glspl{infosystem}} and because of its \textrm{\acrlong{soa}} it can be seen as one large \textrm{\gls{infosystem}}, therefore we can impose reactivity on the Web.
Since communication over services in the Web is often latency driven, we came to the conclusion that asynchronous communication and therefore scalability should be attributes our prototype system has to support natively.
Another aspect to be regarded for the architectural decision was how the rules are going to be represented internally.
We introduced \textrm{\acrshort{xml}} and \textrm{\acrshort{json}} as common ways to communicate data between services on the Web.
Both formats represent data in a tree structure, and this is also what we decided to assume for the explicit parameters in the events that will enter our prototype.
Together with the requirement of native support for an \textrm{\acrlong{eda} (\acrshort{eda})} our decision was to build upon the recent adoption of \textrm{JavaScript} to application development through \textrm{Node.js}\footnote{http://nodejs.org/} and its human-readable \textrm{\acrshort{json}} communication format.
% Why JS, why wasnt it used before? is it used now?

The prototype system consists of several modules, shown in Figure \ref{fig:Architecture}, which we are going to introduce within this section:
\begin{itemize}
	\item \textbf{\textrm{Poller}:} Loads \textrm{Event Trigger} modules and forwards events coming from them to the \textrm{Event Queue}. \textrm{Event Trigger} modules poll for changes in the Web and transform them into events. 
	\item \textbf{\textrm{Webhook Listener}:} Listens on active \textrm{Webhooks} for events and forwards them to the \textrm{Event Queue}.
	\item \textbf{\textrm{Event Queue}:} Buffers events for the case of an overly busy \textrm{Rule Engine}. 
	\item \textbf{\textrm{Rules Engine}:} Picks an event from the \textrm{Event Queue} whenever there is one and it is idle. 
	\item \textbf{\textrm{User Request Handler}:} The user interface modules to administrate \textrm{Event Trigger}, \textrm{Webhooks}, \textrm{Rules} and \textrm{Action Dispatchers}.
\end{itemize}

\begin{figure}[!ht]
	\centering
  \includegraphics[width=\textwidth]{figures/Architecture_Final}
	\caption{Prototype System Architecture}
	\label{fig:Architecture}
\end{figure}



\subsection{Data Structure for Event Parameters}
Events in our prototype system are internally represented as tree structures in \textrm{\acrshort{json}} format, which builds on only two data structures:
\begin{itemize}
	\item Objects: Unordered collections of name/value pairs, which can also be implemented as a hash map, dictionary or struct in other languages.
	\item Arrays: Ordered lists of values, which can also be implemented as a record, vector or list in other languages.
\end{itemize}
A value can be an object or an array, but also a unicode string, a number, boolean or null.
This allows for any arbitrary depth and chaining of the supported data representations.
It is a handy feature when we assume a tree structure for events in our prototype system since the selection of nodes in tree structures has been well studied and useful libraries exist.
Since all native data structures within \textrm{JavaScript} programming code are already in \textrm{\acrshort{json}} format, it can easily be marshalled into one string and communicated to other applications without overhead.
\textrm{\acrshort{json}} can be implemented in virtually every programming language, therefore received a lot of attention and is supported by many \textrm{\glspl{webresource}} for communication.



\subsection{Dynamic Code Loading for Event Trigger and Action Dispatcher}
During our research we have seen many different \textrm{\glspl{webservice}} with thoroughly different requirements in terms of communication.
The easiest category among them were the \textrm{\glspl{webapi}} with their \textrm{\acrshort{rest}}ful services.
And still, in many cases it is only possible to access data which does not refer to an event.
To detect a change in data over time we need to be able to store an earlier request and get the difference to the current request, which could then be transformed into a meaningful event.
The derivation of a meaningful event from data can be a complex task which requires certain operations, which underlines the need for powerful \textrm{Event Trigger} modules.
The complexity is even bigger for \textrm{Action Dispatcher} modules which alter data and require more complex communication to \textrm{\glspl{webservice}}.
For those reasons we made the decision to keep these modules flexible in terms of communication and also to leave it open to expert users to encapsulate complicated logic into them for inexperienced users.
Therefore we modeled the \textrm{Event Trigger} and \textrm{Action Dispatcher} to be \textrm{JavaScript} code modules that are created by expert users during runtime and loaded whenever a rule is activated, which needs them.
These modules run in a sandbox and got only access to certain \textrm{JavaScript} libraries, which are provided by the owner of the system.
Apart from those libraries there are two other important functions offered in both type of modules:
\begin{itemize}
	\item \textrm{log}: Will store log entries on a per rule base, wherever the instruction is met during execution of a module. The log can be seen by the user who created the rule, which includes that module.
	\item \textrm{pushEvent}: This is the most important part for \textrm{Event Trigger} modules, since events are only through this function pushed into the prototype system. For \textrm{Action Dispatcher} modules this gives the sometimes useful option for loopback events.
\end{itemize}



\subsection{Retrieving Events}
In the last chapters, we always put emphasis on the two different ways how events can be retrieved from \textrm{\glspl{infosystem}}, i.e. actively pulling events, or passively retrieving them.
Even though some \textrm{\glspl{infosystem}} offer the access to services that offer data that corresponds to events and can instantly be forwarded into the system, we have seen that there is need for the derivation of events from changes in data on the Web, therefore we need the \textrm{Event Trigger} modules.
But still, our vision is that of an optimal real-time reactive Web which means that all possible events are offered by all \textrm{\glspl{infosystem}}.
An interested remote entity could then just announce interest in a certain kind of events over a \textrm{Webhook} and retrieves them in real-time.
For that reason we laid out our architecture for such \textrm{Webhooks}, but still offer the \textrm{Event Trigger} modules to poll for events in the semi-static \textrm{\gls{www}}.


\subsubsection{Polling for Event Triggers}
As we have pointed out before, \textrm{Event Trigger} modules are \textrm{JavaScript} code modules with access to a set of predefined libraries, which offer the flexibility of \textrm{JavaScript} programming.
The \textrm{Poller} loads those \textrm{Event Trigger} modules whenever they are required as part of a rule.
The user of the \textrm{Event Trigger} can choose a starting point and an interval for the polling to take place.
An example \textrm{\gls{webservice}} which offers polling for events is the \textrm{Email Yak}\footnote{http://www.emailyak.com/} \textrm{\gls{webapi}}, which responds with new emails when requested.
The code required to request the new mails from this service and forward them into the prototype system is quite short and shown in Listing \ref{lst:emailyak}, but for other examples it can get more complex.
For better readability the code is written in \textrm{CoffeeScript}\footnote{http://coffeescript.org/}.
Only expert users are expected to store such a piece of code in our prototype, which enables inexperienced users to simply choose the \texttt{"EmailYal -> newMail"} \textrm{Event Trigger} for their rule.  
A great opportunity to access data from webpages via a \textrm{\gls{webapi}} is \textrm{Import.io}\footnote{https://import.io/}.
By browsing through the Web with their browser it is possible to select certain parts from a webpage and store them in a mask.
Data is instantly extracted from the webpage, using the stored mask, when sending aequest to their \textrm{\gls{webapi}} with the given mask id and the \textrm{\acrshort{uri}}.
This is a great tool for expert users to predefine desired data on webpages and then produce events whenever there is a change in that data.

\begin{lstlisting}[float=h,label=lst:emailyak,language=CoffeeScript,caption=Event Trigger code to poll Email Yak RESTful Web service for new Mails; written in CoffeeScript]
url = "https://api.emailyak.com/v1/#{params.apikey}/json/get/new/email/"
exports.newMail = () ->
	needle.get url, ( err, resp, body ) ->
		if not err and resp.statusCode is 200
				pushEvent mail for mail in body.Emails
\end{lstlisting}



\subsubsection{Webhooks}
As powerful as \textrm{Webhooks} are in bringing us real-time notifications, as simple they are to use.
In our prototype users can easily create as many new \textrm{Webhooks} as they choose to.
The only requirement is, that they are associated to an event name by the user.
A new \textrm{Webhook} will be created in the \textrm{Webhook Listener}, which from then on accepts events posted to it, and the \textrm{Webhook \acrshort{uri}} is displayed to the user.
Any \textrm{\gls{webresource}} that supports the concept of \textrm{Webhooks} (e.g. \textrm{GitHub}\footnote{https://github.com/}) has a place to register the \textrm{Webhook} \textrm{\acrshort{uri}}.
Whenever a remote \textrm{\gls{webresource}} pushes an event to the \textrm{Webhook}, the user-defined event name is assigned as the implicit parameter of a freshly created internal event, while the whole incoming event body is added as explicit parameters to it.
Afterwards it is forwarded to the \textrm{Event Queue}.




\subsection{Action Dispatcher}
% we generate also events again to be pushed over webhooks, and also loopback events
% Actions are functions that need to be predefined as in JSON Rules
% Through this it is possible to provide generic functions for expert user as well as very limited functions with only few possibilities for parameterization to be used by unexperienced persons.
% In our reasearch we focused mainly on server-sided \textrm{Web APIs}, even though we also generated events from the browser and pushed them into our prototype system and let
% But still since SOAP services are request responders they have their place in our model, both as event trigger and action invoker.
% We do not limit ourselves to protocols or architectures of services in the Web, but aim to access all of them in order to exploit the Web's full power.
% event forwarding


\subsection{ECA Rules in the Rule Engine}
% TODO Conditions
 A special case is the \textrm{Rules Administration} because it notifies the \textrm{Poller} and \textrm{Rules Engine} about new or updated Rules, which then in turn load required \textrm{Event Trigger} or \textrm{Action Dispatcher} modules.

% js-select selectors
% List of condition operators

The engine checks the event against its stored ECA rules and fires the actions whenever a rule applies to an event.
When a new rule is stored, the engine instantiates the action modules that are required in case an event arrives at the system which triggers the actions.
% describe internal loop
% Describe rule engine. start from real engine over graphic engine why do we call ours engine
% vague Rule language limited through user acounts to not harm the system
% Describe possible attacks
% is descriptive, adaptive, flexible
% Explain rules, transferrability to language?
% dynamic code modules to shield system from user modules
% explain modules and their properties / user associations




% Apply variable number of function arguments to function

% \section{Grab data from anywhere}

% TODO figure: Wer hat welche rollen?
% TODO figure: Event fluss in verschiedenen UCs



\section{Rule Language for Prototype System} % TODO really PS?
We have also seen that virtual events have an implicit parameter which is the event name, thus this is the one that is referred to in the event part of a rule.
If an event name, of an event entering the \textrm{Rule Engine}, is detected in a predefined rule, the engine compares the event against the conditions of that rule and if all conditions are met, dispatches the actions defined within the rule.
We also assume that \textrm{Action Dispatcher} modules can be accessed through common function invocation syntax ( i.e. \texttt{actionFunction(param1, param2[, ...])} ) in order to dispatch an action to an \textrm{\gls{infosystem}}.
Through this we are able to define a rule language that uses tree node selectors in order to select explicit event parameters, which can then be verified against conditions and forwarded to \textrm{Action Dispatcher} modules as function parameters.
Listing \ref{lst:exampleRulePhrase} shows an example phrase of our envisioned rule language where the retrieval of a new mail will be checked for soccer news and, if confirmed, the mail body will be forwarded to an interested person.

\begin{lstlisting}[language=OwnRule,label={lst:exampleRulePhrase},caption=Example Phrase in Reactive Rule Language]
ON mailevent
IF #{ .subject } instr "Soccer News"
DO mail->send( "soccerfan@host.com", "News about soccer!", #{ .body } )
\end{lstlisting}


% ON (existing categories)
% IF (condition boundaries)
% DO (call to existing action modules with parameters)

% a lot possible, but dangerous.

% \begin{Verbatim}[fontsize=\small,commandchars=\\\{\}]
% \PY{k}{on} \PY{n}{mail}
% \PY{k}{if} \PY{n}{sender}\PY{o}{=}\PY{l+s+ss}{\PYZdq{}sender@mail.com\PYZdq{}}
% \PY{k}{do} \PY{n}{webapi}\PY{o}{\PYZhy{}}\PY{o}{\PYZgt{}}\PY{l+s+s2}{newcontent}\PY{p}{(}\PY{n}{subject}\PY{p}{)}
% \end{Verbatim}

% % TODO Define language with regular expression 
% % Programming language syntax is usually defined using a combination of regular expressions (for lexical structure) and Backus–Naur Form (for grammatical structure). Below is a simple grammar, based on Lisp:
% % expression ::= atom | list
% % atom       ::= number | symbol
% % number     ::= [+-]?['0'-'9']+
% % symbol     ::= ['A'-'Z''a'-'z'].*
% % list       ::= '(' expression* ')'
% \begin{lstlisting}[language=OwnRule,caption=Conceptual ECA Rule Language Syntax]
% expression  ::= 'on ' event ' if ' conditions ' do ' actions
% event       ::= symbol.*(' -> ' symbol.*)
% conditions  ::= 
% actions     ::= symbol*('('selector*')')
% symbol      ::= [A-Za-z0-9_-]+
% selector    ::= [#\{(symbol*?)\}]
% \end{lstlisting









\section{Example Use Cases}
% TODO concrete use case examples
% as seen by user,
% TODO figure: Rules (unions / objects / Rueckkoppelungen )

% Diff comparison of URL


During our research we found a troublesome server room that shows how the \textrm{Web of Things} can be exposed through our model.
This server room suffered from a defective cooling system which lead to a drastical increase of temperature in certain circumstances.
As a consequence certain server automatically shut themselves down as safety measurements.
Eventually, these shutdowns weren't detected immediately by the people that administered these servers, therefore unnecessary downtimes were the result.
As a very quick fix to inform certain administrators about the shutdown of their server, we started pinging these servers and pushed the results int





% {
%     "dominic": {
%         "SOAP test": "{\"id\":\"SOAP test\",\"eventtype\":\"Custom Event\",\"eventname\":\"button-click\",\"conditions\":[],\"actions\":[\"SOAP -> convertCelsiusToFahrenheit\"]}",
%         "Presentation to Pushover": "{\"id\":\"Presentation to Pushover\",\"eventtype\":\"Custom Event\",\"eventname\":\"pushover\",\"conditions\":[],\"actions\":[\"Pushover -> broadcast\"]}",
%         "ProBinder Service Test: FAIL": "{\"id\":\"ProBinder Service Test: FAIL\",\"eventtype\":\"Custom Event\",\"eventname\":\"ProBinderServiceTest\",\"conditions\":[{\"selector\":\".success\",\"type\":\"bool\",\"operator\":\"==\",\"compare\":false}],\"actions\":[\"Pushover -> broadcast\",\"EMailYak -> sendMail\"]}",
%         "ProBinder Service Test": "{\"id\":\"ProBinder Service Test\",\"eventtype\":\"Event Poller\",\"eventname\":\"ProBinder Service Test -> testProBinder\",\"eventstart\":\"2014-05-20T13:00:00.000Z\",\"eventinterval\":120,\"conditions\":[],\"actions\":[\"System -> pushEvent\"],\"timestamp\":\"2014-05-20T11:51:46.307Z\"}",
%         "'button-click' Rule": "{\"id\":\"'button-click' Rule\",\"eventtype\":\"Custom Event\",\"eventname\":\"button-click\",\"conditions\":[],\"actions\":[\"Pushover -> broadcast\"]}",
%         "ProBinder annotate tags": "{\"id\":\"ProBinder annotate tags\",\"eventtype\":\"Event Poller\",\"eventname\":\"ProBinder -> unreadContent\",\"eventstart\":\"2014-05-20T19:11:00.000Z\",\"eventinterval\":1,\"conditions\":[],\"actions\":[\"ProBinder -> annotateTagEntries\",\"ProBinder -> setRead\"],\"timestamp\":\"2014-05-20T19:10:10.951Z\"}",
%         "Coffee Break": "{\"id\":\"Coffee Break\",\"eventtype\":\"Custom Event\",\"eventname\":\"uptimestatistics\",\"conditions\":[{\"selector\":\".currentlyon\",\"type\":\"value\",\"operator\":\">\",\"compare\":42}],\"actions\":[\"EMailYak -> sendMail\"]}",
%         "ProBinder Service Test: Logging": "{\"id\":\"ProBinder Service Test: Logging\",\"eventtype\":\"Custom Event\",\"eventname\":\"ProBinderServiceTest\",\"conditions\":[],\"actions\":[\"ProBinder -> newContent\"]}"
%     }
% }

\section{Web Programming}
% TODO find term in papers (full stack )


\subsection{Node.js}
% Why JS, why wasn't it used up to now? is it used now?

% http://benchmarksgame.alioth.debian.org/u64/benchmark.php?test=all&lang=java&lang2=v8&data=u64 seem to back our findings
% https://www.paypal-engineering.com/2013/11/22/node-js-at-paypal/ as well
% https://vividcortex.com/blog/2013/12/09/analysis-of-paypals-node-vs-java-benchmarks/ interpretes above results:
% My guess is that Node is encouraging good programmer practices in terms of scalability, and Java less so. In other words, programmers probably have to work less hard to avoid bad scalability bottlenecks in Node than in Java.

% TODO Take from preparation

% Umgang mit der Zukunft
% Callback
\subsection{Callback Functions \& Asynchronous Closures}
% JAva futures? objekte für resultate sammeln
% Closures are functions that refer to independent (free) variables. 

Often, optimization approaches and programming language concepts require special attention to avoid common pitfalls.
When closures are used as asynchronous functions, developers need to be very careful not to end up with race conditions.


Looking at an example of sequential code execution in Figure~\ref{fig:Closures_Synchronous}, we see that function execution of \texttt{fA} is halted until function \texttt{fB} is finished.
If \texttt{fB} happens to be a latency-driven I/O operation the completion of \texttt{fA} could be deferred for a relatively long time.
While the application waits for the completion of the I/O operation, some remaining operations in \texttt{fA} could eventually already be executed without causing any race conditions.
\begin{figure}[!ht]
	\centering
  \includegraphics{figures/Closures_Synchronous}
	\caption{Synchronous Function Call}
	\label{fig:Closures_Synchronous}
\end{figure}

Asynchronous code execution, as shown in Figure~\ref{fig:Closures_Asynchronous}, allows non-blocking and thus scalable applications.
Non-blocking operations are a remedy for optimzed resource allocation and open up ways to overcome previously described unnecessary resource bindings.
Processing any kind of latency-driven I/O operation asynchronously ( e.g. filesystem access and socket communication ) exploits resources that would otherwise be bound while waiting for completion.
Such operations are processed and completed whenever required resources are available.
\begin{figure}[!ht]
	\centering
  \includegraphics{figures/Closures_Asynchronous}
	\caption{Asynchronous Function Call}
	\label{fig:Closures_Asynchronous}
\end{figure}

Often other operations depend on the completion of asynchronous operations, hence their execution needs to be deferred.
This necessary code execution deferral is achieved through the use of callback functions, denoted \texttt{fCB} in Figure~\ref{fig:Closures_Asynchronous}.
Any code placed in a callback function, which is assigned to an asynchronous operation, is only executed after the respective asynchronous operation completed.
% TODO figure: Callback; Result ensurance (ergebnissichherung) wird direkt mit funktion mitgeschickt
This allows stacking of functions and operations upon each other which automatically results in a flexible and event-driven application.

So far we didn't regard the context for such asynchronous functions.
If a function has access to the enclosing context where it was invoked in, it is called a closure.
Closures play an important role in ECMAScript\cite{EcmaScript}, which is the base for widely-spread script languages like JavaScript, JScript and ActionScript.
Closures in ECMAScript\cite{EcmaScript} are defined such as they have access to the context of the function they were created in.
This is shown in Figure~\ref{fig:Closures_Closure-1} where \texttt{c} from \texttt{fA}'s context is accessible from within \texttt{fB}, assuming that \texttt{fB} was created in \texttt{fA} and not only invoked from there.
Closures make it necessary for the context of the outer function to survive past its execution so no references are broken.
This is labeled "extended context lifetime" in Figure~\ref{fig:Closures_Closure-1}.
Using asynchronous closures it becomes evident, that the context in the invoking function can change while the closure is still computing and eventually referencing the outer context, thus causing race conditions.
This will be most obvious in a loop that immediately invokes \texttt{fB} several times, as shown in Figure~\ref{fig:Closures_Closure-2}.
In such a setup \texttt{c} will have different values in the same part of different invocations of \texttt{fB}.
\begin{figure}[!ht]
	\centering
  \includegraphics{figures/Closures_Closure-1}
	\caption{Closure Scope and referenced context}
	\label{fig:Closures_Closure-1}
\end{figure}
\begin{figure}[!ht]
	\centering
  \includegraphics{figures/Closures_Closure-2}
	\caption{Closure context changes in a loop}
	\label{fig:Closures_Closure-2}
\end{figure}


Those event-driven context overwrites can be taken care of by shielding the closure from context changes, as shown in Figure~\ref{fig:Closures_Closure-3}.
To shield the closure form context changes, closure \texttt{fB} needs to create another closure \texttt{fC} and return it to \texttt{fA}.
The argument passed to \texttt{fB} is the context ( \texttt{c} in Figure~\ref{fig:Closures_Closure-3} ) that might change but requires to be persistent for one invocation.
\texttt{fC} has now \texttt{c} as a fixed context, which can't be overwritten anymore.
Now the only thing left is \texttt{fC} needs to be invoked and it will retain the original context.
This implementation is necessary when the closure acts as a callback function for asynchronous operations, to preserve the original context in case it is required within the callback function.
\begin{figure}[!ht]
	\centering
  \includegraphics{figures/Closures_Closure-3}
	\caption{Closure Context Shielding}
	\label{fig:Closures_Closure-3}
\end{figure}

% TODO Figures need fA to be right aligned

An example of how closure contexts can be shielded is shown in the Listing \ref{lst_closure}.
\begin{lstlisting}[float=h,label=lst_closure,language=JavaScript,caption=JavaScript Context Shielding]
var fB = function( c ) { // Declare a function...
	var fC =  function( a ) { // ( <-- function to return )
		console.log( c );
	};
	return fC;
};
for( var c = 0; c < 100; c++ ) {
	// ... before you assign it to an event happening in the future:
	var fC = fB( c );
	setTimeout( fC, 3000); // will be executed after the loop ended
}
\end{lstlisting}

% TODO try async closures in other programming languages


% \subsubsection{Benchmarking JavaScript vs. Java}
% refer to listings
% TODO terminierungsproblem, testing, Web server, timeout, stacked callbacks.
%compilerbau?
%loesungsansätze?


% TODO why JS. JSON as first advantage (http://www.toptal.com/nodejs/why-the-hell-would-i-use-node-js)
% advantage for network applications with several concurrent connections
% not as client-server used as intented but as serverserver com since we also expect several connections simultanously under load.
% But also, we adopt the non-blocking nature of JS that is used for node's optimal communication, in order to implement our enigne in a non blocking way, thus allowing to load code and fire callback function in modules whenever they are required!
% http://ariya.ofilabs.com/2012/07/lazy-parsing-in-javascript-engines.html
% Optimization of special case if ( before function {immediately-invoked function expression (IIFE)}, do rela parsing, else lazy parsing
% Difference between context and scope. scope unique to each invocation, context is 'this', owner of currently executing code.
% .call, .apply 
% TODO we should use .bind for persistence.coffee's functions ....

%In JavaScript, functions are first-class objects, i.e. they are objects and can be manipulated and passed around just like any other object. Specifically, they are Function objects. -> https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Functions_and_function_scope
% Since each call provides potentially different arguments, a new closure is created for each call to outside. The memory can be freed only when the returned inside is no longer accessible

% The definitive guide: This combination of a function object and a scope (a set of variable bindings) in which the function’s variables are resolved is called a closure in the computer science literature.4
% This is an old term that refers to the fact that the function’s variables have bindings in the scope chain and that therefore the function is “closed over” its variables.




% Tutorial example: as seen by user, as seen by the developer
